      <section id="build-guide">
        <h2>ビルド・開発コマンド</h2>

        <h3>基本コマンド</h3>
        <table>
          <tr><th>コマンド</th><th>説明</th><th>備考</th></tr>
          <tr><td><code>yarn dev</code></td><td>開発サーバー起動</td><td>Turbopack 使用、ポート 3001</td></tr>
          <tr><td><code>yarn build</code></td><td>プロダクションビルド</td><td>next build</td></tr>
          <tr><td><code>yarn start</code></td><td>プロダクションサーバー起動</td><td>ポート 3001</td></tr>
          <tr><td><code>yarn lint</code></td><td>ESLint 実行</td><td>eslint-config-next</td></tr>
          <tr><td><code>yarn typecheck</code></td><td>TypeScript 型チェック</td><td>tsc --noEmit</td></tr>
        </table>

        <h3>Supabase CLI コマンド</h3>
        <table>
          <tr><th>コマンド</th><th>説明</th></tr>
          <tr><td><code>supabase start</code></td><td>ローカル Supabase 起動（Docker）</td></tr>
          <tr><td><code>supabase stop</code></td><td>ローカル Supabase 停止</td></tr>
          <tr><td><code>supabase db reset</code></td><td>DB リセット（マイグレーション + シード再適用）</td></tr>
          <tr><td><code>supabase migration new {name}</code></td><td>新しいマイグレーション作成</td></tr>
          <tr><td><code>supabase db diff</code></td><td>スキーマ差分の確認</td></tr>
        </table>

        <h3>コミット前チェックリスト</h3>
        <pre><code>
# 1. 型チェック
yarn typecheck

# 2. ビルド確認
yarn build

# 3. Lint
yarn lint

# 4. テスト（実装後）
yarn test
        </code></pre>
      </section>

      <section id="dev-environment">
        <h2>環境設定</h2>

        <h3>必要な環境変数</h3>
        <table>
          <tr><th>変数名</th><th>説明</th><th>例</th></tr>
          <tr><td><code>NEXT_PUBLIC_SUPABASE_URL</code></td><td>Supabase プロジェクト URL</td><td>https://xxxxx.supabase.co</td></tr>
          <tr><td><code>NEXT_PUBLIC_SUPABASE_ANON_KEY</code></td><td>Supabase Anon Key（公開鍵）</td><td>eyJhbGci...</td></tr>
          <tr><td><code>SUPABASE_SERVICE_ROLE_KEY</code></td><td>Supabase Service Role Key（秘密鍵）</td><td>eyJhbGci...</td></tr>
          <tr><td><code>AUTH_SECRET</code></td><td>JWT 署名用シークレット</td><td>32文字以上のランダム文字列</td></tr>
          <tr><td><code>BASE_DOMAIN</code></td><td>ベースドメイン</td><td>kuratsugi.app</td></tr>
          <tr><td><code>NEXT_PUBLIC_BASE_DOMAIN</code></td><td>ベースドメイン（クライアント用）</td><td>kuratsugi.app（※現在未使用、将来のクライアント側テナント解決用に予約）</td></tr>
          <tr><td><code>NODE_ENV</code></td><td>実行環境</td><td>development / production</td></tr>
          <tr><td><code>CRON_SECRET</code></td><td>Cron Job認証用シークレット</td><td>openssl rand -base64 32 で生成</td></tr>
          <tr><td><code>RESEND_API_KEY</code></td><td>Resend メール送信APIキー</td><td>re_xxxxxxxxx</td></tr>
          <tr><td><code>EMAIL_FROM</code></td><td>メール送信元アドレス</td><td>noreply@kuratsugi.app</td></tr>
        </table>

        <h3>ローカル開発セットアップ</h3>
        <pre><code>
# 1. リポジトリクローン
git clone {repo-url}
cd azukari-banto-saas

# 2. 依存関係インストール
yarn install

# 3. 環境変数設定
cp .env.example .env.local
# .env.local を編集して各値を設定

# 4. Supabase ローカル起動（Docker Desktop 必要）
supabase start

# 5. マイグレーション適用 + シードデータ投入
supabase db reset

# 6. 開発サーバー起動
yarn dev

# 7. ブラウザでアクセス
# http://localhost:3001
# x-tenant-slug ヘッダーで テナント指定
        </code></pre>

        <h3>開発環境でのテナント指定</h3>
        <p>ローカル開発ではサブドメインを使用できないため、以下の方法でテナントを指定します:</p>
        <table>
          <tr><th>方法</th><th>説明</th></tr>
          <tr><td>ヘッダー</td><td><code>x-tenant-slug: A3F0</code> ヘッダーを付与</td></tr>
          <tr><td>ログインAPI</td><td>リクエストボディの <code>tenantSlug</code> フィールドで指定</td></tr>
        </table>

        <h3>マイグレーションファイル構成</h3>
        <table>
          <tr><th>ファイル</th><th>内容</th></tr>
          <tr><td><code>20260214000001_initial_schema.sql</code></td><td>ENUM定義、全テーブル作成、インデックス、トリガー</td></tr>
          <tr><td><code>20260214000002_rls_policies.sql</code></td><td>RLS有効化、テナント分離ポリシー、サービスロールポリシー</td></tr>
        </table>

        <h3>シードデータ</h3>
        <p><code>supabase/seed.sql</code> に開発用テストデータが含まれています:</p>
        <table>
          <tr><th>データ</th><th>内容</th></tr>
          <tr><td>テナント</td><td>A3F0（デモ着物店）、B1C2（テスト呉服店）</td></tr>
          <tr><td>プラットフォーム管理者</td><td>admin@kuratsugi.app</td></tr>
          <tr><td>担当者</td><td>TK7M 田中太郎、TM2P 鈴木花子</td></tr>
          <tr><td>業者</td><td>V001 着物ブレイン、V002 京都染工房</td></tr>
          <tr><td>設定</td><td>company_name、alert_days_before_due、archive_days_after_complete</td></tr>
        </table>
      </section>

      <section id="coding-standards">
        <h2>コーディング規約</h2>

        <h3>ディレクトリ命名規則</h3>
        <table>
          <tr><th>種別</th><th>規則</th><th>例</th></tr>
          <tr><td>ページ</td><td>kebab-case</td><td><code>paid-storage/page.tsx</code></td></tr>
          <tr><td>コンポーネント</td><td>PascalCase</td><td><code>AdminSidebar.tsx</code></td></tr>
          <tr><td>ユーティリティ</td><td>camelCase</td><td><code>rate-limit.ts</code></td></tr>
          <tr><td>型定義</td><td>PascalCase（型名）</td><td><code>ItemStatus</code>, <code>SessionData</code></td></tr>
          <tr><td>API Routes</td><td>kebab-case ディレクトリ + route.ts</td><td><code>api/auth/worker/route.ts</code></td></tr>
        </table>

        <h3>TypeScript 規約</h3>
        <ul>
          <li>型定義は <code>src/types/index.ts</code> に集約</li>
          <li>インターフェース名は PascalCase、プレフィックス <code>I</code> は不要</li>
          <li>ENUM 的な値はリテラル型のユニオンで定義（TypeScript の enum は使用しない）</li>
          <li>ラベルマッピングは <code>Record&lt;Type, string&gt;</code> で定義</li>
          <li>遷移ルール等のビジネスロジックは型定義ファイル内に配置</li>
        </ul>

        <h3>Supabase クライアント使い分け</h3>
        <table>
          <tr><th>場面</th><th>クライアント</th><th>インポート</th></tr>
          <tr><td>ブラウザ（Client Component）</td><td>Anon Key</td><td><code>import { createClient } from '@/lib/supabase/client'</code></td></tr>
          <tr><td>Server Component</td><td>Anon Key + Cookie</td><td><code>import { createClient } from '@/lib/supabase/server'</code></td></tr>
          <tr><td>API Route（認証前）</td><td>Service Role</td><td><code>import { createServiceClient } from '@/lib/supabase/server'</code></td></tr>
          <tr><td>Cron ジョブ</td><td>Service Role</td><td><code>import { createServiceClient } from '@/lib/supabase/server'</code></td></tr>
        </table>

        <h3>セキュリティ原則</h3>
        <ul>
          <li>API キーや PIN をハードコードしない</li>
          <li>Service Role Key はサーバーサイドでのみ使用（NEXT_PUBLIC_ プレフィックスを付けない）</li>
          <li>Cookie は httpOnly + secure + sameSite=strict</li>
          <li>全テナントアクセスには Service Role を使用し、テナント単位のアクセスは RLS を活用</li>
          <li>ユーザー入力は常にバリデーション（PIN は8桁数字、slug は英数字+ハイフン）</li>
        </ul>

        <h3>Git ブランチ運用</h3>
        <table>
          <tr><th>ブランチ</th><th>用途</th><th>ルール</th></tr>
          <tr><td><code>main</code></td><td>本番リリース</td><td>直接コミット禁止</td></tr>
          <tr><td><code>develop</code></td><td>開発統合</td><td>feature ブランチからマージ</td></tr>
          <tr><td><code>feature/*</code></td><td>機能開発</td><td>develop から分岐・マージ</td></tr>
          <tr><td><code>fix/*</code></td><td>バグ修正</td><td>develop から分岐・マージ</td></tr>
        </table>

        <h3>コミットメッセージ</h3>
        <p>コンベンショナルコミット形式。メッセージ本文は日本語:</p>
        <pre><code>
feat: 預かり登録ウィザードの実装
fix: ステータス遷移のバリデーション修正
docs: API仕様書の更新
refactor: Supabaseクライアントの共通化
test: 認証フローのユニットテスト追加
chore: 依存パッケージの更新
        </code></pre>
      </section>

      <section id="deployment">
        <h2>デプロイ</h2>

        <h3>Vercel デプロイ構成</h3>
        <table>
          <tr><th>項目</th><th>設定</th></tr>
          <tr><td>フレームワーク</td><td>Next.js（自動検出）</td></tr>
          <tr><td>ビルドコマンド</td><td><code>yarn build</code></td></tr>
          <tr><td>出力ディレクトリ</td><td><code>.next</code>（自動）</td></tr>
          <tr><td>Node.js バージョン</td><td>20.x</td></tr>
          <tr><td>ドメイン</td><td><code>*.kuratsugi.app</code>（ワイルドカード）</td></tr>
        </table>

        <h3>環境変数の設定先</h3>
        <table>
          <tr><th>変数</th><th>Vercel 環境</th><th>ローカル</th></tr>
          <tr><td>NEXT_PUBLIC_SUPABASE_URL</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>NEXT_PUBLIC_SUPABASE_ANON_KEY</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>SUPABASE_SERVICE_ROLE_KEY</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>AUTH_SECRET</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>BASE_DOMAIN</td><td>Production のみ</td><td>.env.local</td></tr>
          <tr><td>CRON_SECRET</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>RESEND_API_KEY</td><td>Production / Preview</td><td>.env.local</td></tr>
          <tr><td>EMAIL_FROM</td><td>Production / Preview</td><td>.env.local</td></tr>
        </table>

        <h3>テナント追加手順</h3>
        <pre><code>
-- 1. テナント登録
INSERT INTO tenants (slug, name, plan, status) VALUES
  ('C4D5', '新しい呉服店', 'standard', 'active');

-- 2. 担当者登録（PINはbcryptでハッシュ化）
INSERT INTO workers (tenant_id, worker_id, name, pin_hash) VALUES
  ('{tenant_uuid}', 'TK7M', '担当者名', '{bcrypt_hash}');

-- 3. DNS設定
-- C4D5.kuratsugi.app を Vercel に向ける（ワイルドカード設定済みなら不要）

-- 4. 初期設定
INSERT INTO tenant_settings (tenant_id, key, value) VALUES
  ('{tenant_uuid}', 'company_name', '新しい呉服店'),
  ('{tenant_uuid}', 'alert_days_before_due', '3');
        </code></pre>
      </section>
