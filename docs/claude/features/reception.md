# 受付ウィザード + 顧客・取引先選択

**状態:** TODO（プレースホルダーのみ）

## 受付ウィザードフロー

預かり登録は「商品先行」のウィザード形式（6ステップ）:

```text
Step 1: photo（写真撮影）
  ├─ カメラ起動（MediaDevices API）
  ├─ 表面撮影（必須）+ メモ入力（任意）
  ├─ 裏面撮影（必須）+ メモ入力（任意）
  └─ 追加写真（任意、枚数無制限）+ メモ入力
  ※ 2点目以降は紐付け先の顧客名を表示
  ※ カメラ使用不可時はファイルアップロードで代替可能

Step 2: itemDetails（商品情報入力）
  ├─ 商品種別（必須）、商品名（任意）
  ├─ 色・柄、素材、状態メモ
  ├─ 加工種別、加工指示
  ├─ 長期保管（有料預かり）チェックボックス
  └─ 発送予定日（業者への発送予定、デフォルト: 当日）
  ※ 返送予定日は預かり時には入力しない
  ※ 有料預かりにチェックすると返却受入時の返送予定日制限がなくなる

Step 3: customer（顧客紐付け）※1点目のみ
  ├─ 顧客区分選択（取引先経由 / 個人）
  ├─ [取引先経由] 取引先選択（検索＋五十音インデックス）→ 顧客選択/新規登録
  └─ [個人] 顧客検索 → 顧客選択/新規登録（電話・住所必須）

Step 4: addMore（追加確認）←─────────────────┐
  ├─ [追加する] → Step 1へ戻る（同一顧客に紐付け）─┘
  └─ [終了] ↓

Step 5: confirm（確認）
  └─ 登録内容確認 → 受付登録実行

Step 6: complete（完了）
  └─ 受付番号・全預かり番号の表示
```

---

## 下書き保存（顧客未設定）

商品情報入力後、顧客選択に進む前に下書きとして自動保存される。

- **保存タイミング**: 商品情報確定時（顧客選択ステップへ進む直前）
- **ステータス**: `draft`（顧客未設定）
- **ダッシュボード表示**: 「顧客未設定」セクションに受付番号単位でグループ表示
- **顧客紐付け**: ダッシュボードからクリックすると、顧客選択ステップから再開
- **復元の優先**: URLパラメータ`?draft=xxx`が指定された場合、localStorage復元ダイアログより優先

```text
[商品情報入力] → [下書き保存（draft）] → [顧客選択] → [登録完了（pending_ship）]
                         ↓
              [ダッシュボードに表示]
                         ↓
              [クリックで顧客紐付け再開]
```

---

## ポイント

- 写真撮影ステップと商品情報入力ステップを分離
- 表面・裏面の写真は両方必須
- 各写真にメモを追加可能（気になる箇所の説明等）
- 追加写真は何枚でも登録可能（気になる箇所の詳細撮影用）
- 商品名・品目は任意入力（商品種別は必須）
- 返送予定日は預かり登録時には設定しない（返却受入後に設定）
- 2点目以降は顧客選択をスキップし、同一顧客に紐付け
- カメラは`navigator.mediaDevices.getUserMedia`で直接起動
- カメラが使用できない場合はファイルアップロードにフォールバック
- **続けて登録**: 完了後に同じ顧客・取引先で新しい受付を開始（顧客選択スキップ）

---

## 写真アップロード

### 預かり時の写真（必須）

- 商品1点につき2枚（表面・裏面）**両方必須**
- 撮影方法: MediaDevices API（カメラ直接起動）
- 保存先: **Supabase Storage**
- 保存先カラム: `photo_front_url`, `photo_back_url`

### 追加写真

- 枚数無制限
- 保存先: `additional_photos` カラム（JSONB配列）
- 各写真にメモ付与可能

```json
[
  { "url": "https://xxx.supabase.co/storage/...", "memo": "袖口のシミ" },
  { "url": "https://xxx.supabase.co/storage/...", "memo": "裾のほつれ" }
]
```

---

## カメラ設定（KURATSUGI版準拠）

| 設定項目 | 値 |
| -------- | -- |
| 解像度（理想） | 1920x2560（フォールバック: 1280x1920） |
| 保存最大サイズ | 1600x2400 |
| WebP品質 | 0.85 |
| JPEG品質（フォールバック） | 0.8 |
| オートフォーカス | 連続（対応デバイスのみ） |
| ズーム | 最小値に設定（デジタルズーム回避） |

---

## 番号体系

### 受付番号

- 形式: `{担当者ID}-{YYYYMMDDHHmm}`
- 例: `T01-202601181430`
- 生成: `getJSTTimestampMinutes()` 使用

### 預かり番号

- 形式: `{担当者ID}-{YYYYMMDDHHmmss}-{連番2桁}`
- 例: `T01-20260118143025-01`
- 生成: `getJSTTimestamp()` 使用

---

## 取引先選択UI

大量の取引先（200件以上）から効率的に選択できるUI。

### 機能

- **検索ボックス**: 名前・カナ・担当者名で部分一致検索
- **五十音インデックス**: あ〜わの11ボタンでフィルタリング
- **件数表示**: フィルタリング結果の件数を表示

### 五十音インデックスのマッピング

| ボタン | 対象文字（カタカナ） |
|--------|----------------------|
| 全て | フィルターなし |
| あ | ア行（ア、イ、ウ、エ、オ） |
| か | カ行（カ〜コ、ガ〜ゴ） |
| さ | サ行（サ〜ソ、ザ〜ゾ） |
| た | タ行（タ〜ト、ダ〜ド） |
| な | ナ行（ナ〜ノ） |
| は | ハ行（ハ〜ホ、バ〜ボ、パ〜ポ） |
| ま | マ行（マ〜モ） |
| や | ヤ行（ヤ、ユ、ヨ） |
| ら | ラ行（ラ〜ロ） |
| わ | ワ行（ワ、ヲ、ン） |

※ `name_kana`フィールドの先頭文字で判定
※ ひらがな・半角カタカナは全角カタカナに変換して比較

---

## 顧客選択UI

取引先経由の受付では、選択した取引先に紐づいた顧客のみが検索・表示される。

### 動作仕様

| 顧客区分 | 検索対象 | 紐付け方法 |
|----------|---------|-----------:|
| 取引先経由 | 選択した取引先に紐づいた顧客のみ | `partner_id`でフィルタリング |
| 個人 | 全顧客（partner_id問わず） | フィルタリングなし |

### 紐付けルール

- **取引先経由**: 顧客は`partner_id`と`partner_name`で取引先に紐付く
- **紐付けの管理**: 顧客を取引先に紐付ける操作は管理画面（`/admin/customers`）で管理者が実施
- **紐付けなし顧客**: 取引先に紐付いていない顧客は、取引先経由の受付では表示されない

### 顧客情報の必須項目

| 区分 | 必須項目 | 備考 |
| ---- | -------- | ---- |
| 取引先経由 | 顧客名 | partner_id/partner_nameで取引先に紐付け |
| 個人 | 顧客名、電話番号、住所 | 返送のため連絡先・配送先が必須 |

---

## API

| エンドポイント | メソッド | 説明 | 状態 |
| -------------- | -------- | ---- | ---- |
| /api/receptions | POST | 受付登録（商品一括作成） | TODO |
| /api/receptions/draft | POST | 下書き保存（顧客未設定） | TODO |
| /api/receptions/[receptionNumber]/customer | PATCH | 下書きへの顧客紐付け | TODO |
| /api/customers | GET | 顧客検索 | TODO |
| /api/customers | POST | 顧客新規登録 | TODO |
| /api/partners | GET | 取引先一覧 | TODO |
| /api/photos/upload | POST | 写真アップロード（Supabase Storage） | TODO |
| /api/photos/upload-temp | POST | 写真一時アップロード | TODO |

---

## テナント分離

- 受付登録時、セッションの`tenantId`を使用してデータを分離
- receptions/items テーブルの`tenant_id`カラムに自動設定
- RLSポリシーにより他テナントのデータは参照不可

---

## TODO

- [ ] ウィザードUIコンポーネントの実装（`src/components/reception/`）
- [ ] 写真撮影コンポーネント（カメラ/ファイルアップロード切替）
- [ ] 写真アップロードAPI（Supabase Storage）
- [ ] 顧客検索・新規登録API
- [ ] 取引先一覧API
- [ ] 受付番号・預かり番号の自動採番
- [ ] 下書き保存・復元機能
- [ ] フォーム入力のlocalStorage保存（`usePersistedState`）
