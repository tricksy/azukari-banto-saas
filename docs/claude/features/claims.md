# クレーム管理

**状態:** UIシェル（タブのみ、データ連携TODO）

商品に関するクレームを登録・追跡・解決するための管理システム。

**URL:** `/admin/claims`（管理者）、商品詳細画面からもアクセス可能
**ファイル:** `src/app/admin/(dashboard)/claims/page.tsx`

---

## 概要

- クレームは商品（`item_number`）に紐づく独立したエンティティ
- クレームステータスと商品ステータスは独立して管理
- 商品に `is_claim_active` フラグでアクティブなクレームの有無を追跡
- 型定義は `src/types/index.ts` に定義済み

---

## クレームステータス

シンプル2段階フロー: `open`（対応中）→ `closed`（完了）

| ステータス | コード | 説明 |
| ---------- | ------ | ---- |
| 対応中 | open | クレーム発生中、対応が必要 |
| 完了 | closed | 対応完了、解決内容を記録済み |

---

## クレームカテゴリ

| コード | 表示名 | 説明 |
| ------ | ------ | ---- |
| quality | 品質 | 仕上がり品質、加工ミス、汚損など |
| delivery | 納期 | 納期遅延、発送遅延など |
| response | 対応 | 接客対応、連絡不備など |
| other | その他 | 上記に該当しないクレーム |

---

## 画面構成

**2タブ構成:**

| タブ | 表示対象 | 機能 |
| ---- | -------- | ---- |
| 対応中 | `open`ステータスのクレーム | アクティブなクレームの一覧表示 |
| 完了 | `closed`ステータス | 完了済みクレームの履歴 |

---

## 機能

### 1. クレーム一覧

- ステータスバッジ表示（対応中: 黄土、完了: 緑）
- 顧客名・取引先名・商品種別を表示
- 経過日数を表示（対応中のみ、7日以上は強調表示）
- 対応メモ件数・最終対応日時を表示
- 検索機能（顧客名・取引先・商品番号で絞り込み）
- クリックで詳細モーダル表示

### 2. クレーム詳細モーダル

- 顧客情報・商品情報・経過日数を表示
- クレーム内容・対応ログの表示
- 対応メモの追加
- クローズ処理（解決内容を記録・必須）
- 再オープン機能

### 3. 商品詳細画面からのアクセス

- 商品詳細画面にクレーム履歴セクションを表示
- 新規クレーム登録ボタン
- クレーム詳細へのリンク（対応履歴表示・メモ追加機能付き）

### 4. ダッシュボードからのアクセス

- 「クレーム対応中」カードをクリックで `/admin/claims` へ遷移

### 5. クレーム対応中ラベル表示

- 商品一覧・検索結果でステータスバッジの横に「クレーム対応中」ラベルを表示

---

## クレーム対応フラグ（is_claim_active）

### フラグON時の動作

商品詳細画面の「ステータス変更」モーダルで `is_claim_active` を OFF → ON に変更する場合:

**既存クレームがある場合:**
1. チェックをONにすると、「既存クレーム CLM-xxx に対応メモとして追加されます」と表示
2. 対応内容を入力
3. 既存クレームの `claim_logs` に対応メモとして追加される

**既存クレームがない場合:**
1. チェックをONにすると、「※ 新規クレームとして登録されます」と表示
2. クレーム内容を入力
3. 新規クレームが作成され、商品の `is_claim_active` がtrueに更新される

### フラグOFF時の動作

ON → OFF に変更する場合、**解決内容の入力が必須**。

1. チェックをOFFにすると、「解決内容」入力欄が表示
2. 解決内容を入力（必須）
3. 全オープンクレームが解決理由付きでクローズ
4. 商品の `is_claim_active` が `false` に更新

### API保護

- `is_claim_active` を `false` にする際、オープンなクレームが存在する場合はエラー（400）を返す
- エラーメッセージ: 「オープンなクレームが存在します。先にクレームを解決してください。」
- これにより、データ整合性が保たれる

---

## クレーム登録フロー

**方法1: 新規クレーム登録ボタンから**
```text
商品詳細画面 → 「新規クレーム登録」ボタン → クレーム内容入力 → 登録
                                                              ↓
                                              商品.is_claim_active = true
                                              claims テーブルに新規登録
                                              claim_logs に初期ログ
```

**方法2: ステータス変更モーダルからフラグON**
```text
商品詳細画面 → 「ステータス変更」ボタン → 「クレーム対応中」チェックON
                                                              ↓
                                         クレーム内容メモ入力（必須）
                                                              ↓
                                         「変更する」ボタン
                                                              ↓
                                         新規クレームが自動作成
                                         商品.is_claim_active = true
```

---

## クレームクローズフロー

```text
クレーム詳細 → 「クローズ」ボタン → 解決内容入力（必須） → クローズ
                                                          ↓
                                         claims.status = 'closed'
                                         claims.resolution = 解決内容
                                         商品.is_claim_active = false（他に未解決クレームがなければ）
                                         claim_logs に完了ログ
```

---

## メール通知

クレーム関連の操作時に、アクティブな全担当者へメール通知を送信する。

### 通知トリガー

| 操作 | 通知 | 内容 |
| ---- | ---- | ---- |
| クレーム新規登録 | ○ | クレーム情報 |
| 対応メモ追加 | ○ | クレーム情報 + 対応履歴 |
| クレーム更新 | ○ | クレーム情報 + 対応履歴 |
| クローズ | ○ | クレーム情報 + 対応履歴 + 解決内容 |

---

## データベーステーブル

### claims テーブル

| カラム | 型 | 説明 |
| ------ | -- | ---- |
| claim_id | TEXT | クレームID（例: CLM-20260119120000） |
| item_number | TEXT | 紐付く預かり番号 |
| customer_name | TEXT | 顧客名 |
| status | claim_status | ステータス（open/closed） |
| category | claim_category | カテゴリ |
| description | TEXT | クレーム内容 |
| assignee_id | TEXT | 担当者ID |
| assignee_name | TEXT | 担当者名 |
| due_date | DATE | 対応期限 |
| resolution | TEXT | 解決内容 |

### claim_logs テーブル

| カラム | 型 | 説明 |
| ------ | -- | ---- |
| log_id | TEXT | ログID |
| claim_id | TEXT | 紐付くクレームID |
| item_number | TEXT | 商品番号（検索用） |
| action | claim_log_action | アクション（opened/updated/closed/reopened） |
| note | TEXT | 対応内容メモ |

---

## API

| エンドポイント | メソッド | 説明 | 状態 |
| -------------- | -------- | ---- | ---- |
| /api/claims | GET | クレーム一覧 | TODO |
| /api/claims | POST | クレーム新規登録 | TODO |
| /api/claims/[claimId] | GET | クレーム詳細 | TODO |
| /api/claims/[claimId] | PATCH | クレーム更新 | TODO |
| /api/claims/[claimId]/logs | GET | 対応ログ一覧 | TODO |
| /api/claims/[claimId]/logs | POST | 対応ログ追加 | TODO |

---

## TODO

- [ ] クレーム一覧のデータ取得
- [ ] クレーム詳細モーダル
- [ ] クレーム登録フォーム
- [ ] 対応ログの表示・追加
- [ ] クローズ処理（解決内容必須）
- [ ] 再オープン機能
- [ ] 商品詳細画面からのクレームアクセス
- [ ] is_claim_active フラグ連動
- [ ] メール通知送信
- [ ] 操作ログ記録
