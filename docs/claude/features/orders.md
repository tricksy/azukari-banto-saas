# 発注管理 + 加工指示書印刷

**状態:** UIシェル（タブのみ、データ連携TODO）

## 発注管理

業者への発送待ち（`pending_ship`）および再加工（`rework`）商品の業者への発送を管理する画面。

**URL:** `/orders`
**ファイル:** `src/app/(worker)/orders/page.tsx`

---

## 画面構成

タブ切り替えで発送待ちと再加工を管理。`usePersistedState`でタブ状態を保持。

| タブ | ステータス | 操作 | 遷移先 |
| ---- | ---------- | ---- | ------ |
| 発送待ち | `pending_ship` | 業者への発送 / キャンセル | `processing` / `cancelled` |
| 再加工 | `rework` | 業者への再発送 | `processing` |

---

## 商品カード表示

- チェックボックス（複数選択用）
- 商品写真サムネイル（表面・裏面の2枚表示、48x48px）
  - クリックで写真拡大モーダル表示
- 顧客名、商品種別バッジ、クレームバッジ
- 預かり番号（短縮形式: `{担当者ID}-{末尾9文字}`）
- 発送予定日、加工種別

---

## 機能

- 複数商品の一括選択・操作
- カード全体タップで選択ON/OFF（タッチフレンドリー）
- 写真サムネイルクリックで拡大表示（モーダル、カード選択は発生しない）
- 業者選択・発送日登録、加工指示書印刷
- 業者選択時に発送先住所を自動表示（郵便番号・住所・電話番号）
- 住所未登録の業者は警告表示
- **送り状情報登録（任意）**: 発送時に送り状番号・配送業者を登録可能
- **キャンセル機能**（発送待ちタブのみ）: キャンセル理由入力 → `cancelled`ステータスへ
- **再加工時の業者デフォルト選択**: 元の業者を自動選択（変更可能）

---

## 発送登録モーダル

| 項目 | 必須 | 説明 |
| ---- | ---- | ---- |
| 発注先業者 | ○ | 発送先の業者を選択 |
| 発送日 | ○ | 発送日を入力（今日以前） |
| 送り状番号 | × | 配送業者の送り状番号（任意） |
| 配送業者 | × | ヤマト運輸/佐川急便/日本郵便/その他（任意） |

---

## 送り状追跡リンク

登録した送り状番号は、商品詳細画面や返却受入画面で追跡リンクとして表示。

| 配送業者 | 追跡URL |
| -------- | ------- |
| ヤマト運輸 | `https://member.kms.kuronekoyamato.co.jp/parcel/detail?pno={番号}` |
| 佐川急便 | `https://k2k.sagawa-exp.co.jp/p/web/okurijosearch.do?okurijoNo={番号}` |
| 日本郵便 | `https://trackings.post.japanpost.jp/services/srv/search/direct?locale=ja&reqCodeNo1={番号}` |
| その他 | リンクなし（番号のみ表示） |

※ 追跡URL生成関数は `src/types/index.ts` に定義済み

---

## ステータス遷移

| 操作 | 遷移 | 画面 |
| ---- | ---- | ---- |
| 業者への発送 | pending_ship → processing | /orders（発送待ちタブ） |
| キャンセル | pending_ship → cancelled | /orders（キャンセルモーダル） |
| 業者への再発送 | rework → processing | /orders（再加工タブ） |

---

## 加工指示書印刷

加工指示書の印刷ページ。**1商品につき必ず1ページ**に収まるA4レイアウト。

**URL:**
- `/print/processing-order/{receptionNumber}` — 受付番号の全商品
- `/print/processing-order/selected?itemNumbers=xxx,yyy` — 指定商品のみ
- `?vendorId=xxx` — 業者情報を含める（任意）

### レイアウト

| セクション | 内容 |
| ---------- | ---- |
| ヘッダー | ロゴ（左）+ タイトル「加工指示書」（横並び）+ ページ番号（右） |
| 預かり番号 | 「預かり番号：」ラベル付きで大きく表示 |
| 顧客情報 | 取引先名、顧客名、受付日 |
| 依頼先 | 業者名、住所、電話番号 |
| 商品情報 | 種別、商品名、色柄、素材、サイズ |
| 加工依頼 | 依頼種別、依頼詳細 |
| 状態メモ | 黄色背景で強調表示（ある場合のみ） |
| 写真 | 表面・裏面（75mm高さ、1ページに収まるサイズ） |

### 特徴

- 明朝体フォント（`font-mincho`）で和風な印象
- 再加工指示書: `rework`ステータスの場合、タイトルが「再加工指示書」に変更
- 1商品1ページ: `page-break-after: always`で強制改ページ
- A4印刷最適化（8mm余白、写真75mm高さ）

---

## データベーステーブル

### items テーブル（関連カラム）

| カラム | 型 | 説明 |
| ------ | -- | ---- |
| vendor_id | TEXT | 業者ID |
| vendor_name | TEXT | 業者名 |
| scheduled_ship_date | DATE | 発送予定日（業者へ） |
| ship_to_vendor_date | DATE | 業者発送日（実績） |
| vendor_tracking_number | TEXT | 業者発送送り状番号 |
| vendor_carrier | carrier_type | 業者発送配送業者 |
| ship_history | JSONB | 業者発送履歴 |

### ship_history 構造

```json
[
  {
    "date": "2026-01-15",
    "vendorId": "V001",
    "vendorName": "着物ブレイン",
    "trackingNumber": "1234-5678-9012",
    "carrier": "yamato"
  }
]
```

---

## API

| エンドポイント | メソッド | 説明 | 状態 |
| -------------- | -------- | ---- | ---- |
| /api/items | GET | ステータス別商品一覧 | TODO |
| /api/items/[itemNumber] | PATCH | ステータス遷移・発送情報更新 | TODO |
| /api/vendors | GET | 業者一覧 | TODO |

---

## TODO

- [ ] pending_ship/rework の商品一覧取得
- [ ] 業者選択ドロップダウン
- [ ] 発送登録モーダル（業者・日付・送り状番号）
- [ ] 一括選択・操作UI
- [ ] キャンセルモーダル
- [ ] ステータス遷移API呼び出し
- [ ] 加工指示書印刷ページ
- [ ] 操作ログ記録
