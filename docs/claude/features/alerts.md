# アラートシステム + 写真要件

**状態:** TODO（未実装）

## アラートシステム

- **対象**: 発送予定超過、返送予定超過、有料預かり中の商品
- **タイミング**: 毎日1回、設定時間に統合サマリーメールを送信
- **通知先**: アクティブな全担当者のメールアドレス
- **実行**: Vercel Cron Jobs
- **メール送信**: 未定（Resend等を検討中）
- **認証**: `CRON_SECRET` による Bearer認証（本番環境のみ）

---

## 統合サマリーメール

すべてのアラート種別を1通のメールにまとめて送信。

### 含まれる内容

| セクション | 対象 | 条件 |
|----------|------|------|
| 発送超過 | pending_ship | scheduled_ship_date < 今日 |
| 返送超過 | returned | scheduled_return_date < 今日 & return_to_customer_dateが空 |
| 有料預かり | paid_storage | 全件 |

### 特徴

- 0件のセクションも「対象なし」として表示
- スマホ最適化のカードレイアウト
- 侘寂デザインシステム準拠

---

## メールテンプレート

**KURATSUGI版との差分:**

| 項目 | KURATSUGI | SaaS版 |
| ---- | --------- | ------ |
| 送信方式 | GAS経由でGmail送信 | 未定（Resend等を検討） |
| テンプレート | TypeScriptで実装 | 同様にTypeScriptで実装予定 |
| テナント対応 | なし（1店舗） | テナント別に設定・送信 |

### 対応するメールタイプ（予定）

| タイプ | 用途 |
|--------|------|
| 日次サマリー | 発送超過・返送超過・有料預かりを統合 |
| クレーム通知 | クレーム発生・更新通知 |
| カスタムメール | テストメール等 |

---

## 管理画面からの手動送信

**設定画面:** `/admin/settings`

| ボタン | 動作 |
|--------|------|
| テストメール | 送信テスト用メール（機能確認用） |
| 日次サマリー送信 | Cronと同じ内容を即時送信 |

---

## テナント設定

| 設定キー | デフォルト | 説明 |
| -------- | ---------- | ---- |
| alertEmailEnabled | false | メール通知有効/無効 |
| alertEmailTo | — | 通知先メールアドレス |
| shipDeadlineDays | 7 | 業者発送期限（日） |
| returnDeadlineDays | 14 | 顧客返送期限（日） |
| staleWarningDays | 30 | 滞留警告しきい値（日） |
| autoArchiveDays | 365 | 自動アーカイブ（日） |

---

## 写真要件

### 預かり時の写真（必須）

- 商品1点につき2枚（表面・裏面）**両方必須**
- 撮影方法: MediaDevices API（カメラ直接起動）
- 保存先: **Cloudflare R2**
- ファイル保存先: テナント別バケット or パスプレフィックス
- 保存先カラム: `photo_front_url`, `photo_back_url`

### 加工後の写真（返却受入時・必須）

- 業者から返却された商品を「返却受入」する際に撮影
- 商品1点につき2枚（表面・裏面）**両方必須**
- 保存先カラム: `photo_after_front_url`, `photo_after_back_url`

### 共通仕様

- 形式: JPEG/PNG（Base64でAPI送信）
- アップロード方式: Cloudflare R2（S3互換API）
- テナント分離: ストレージパスに`tenant_id`を含める

---

## カメラ制御

### ズーム制御

- カメラストリーム取得後にzoomを最小値（1x）に設定
- iOS/Androidでは高解像度を要求するとデジタルズームが適用されることがあるため
- `track.applyConstraints({ advanced: [{ zoom: capabilities.zoom.min }] })`

### 解像度設定

- 理想値: 1280x1920（縦向き優先）
- キャプチャ時の最大解像度: 1024x1536（アップロード高速化のため）
- 形式: WebP優先（品質0.7）、非対応ブラウザはJPEGフォールバック（品質0.6）

---

## 写真表示

**商品詳細画面での写真表示:**

- 写真クリック時はアプリ内モーダルで拡大表示
- モーダルは背景クリックまたは×ボタンで閉じる
- `object-contain`で画像全体を表示

---

## Cron Job

**エンドポイント:** `GET /api/cron/alerts`

**vercel.json設定:**
```json
{
  "crons": [
    {
      "path": "/api/cron/alerts",
      "schedule": "0 0 * * *"
    }
  ]
}
```

### テナント別処理

SaaS版ではCron Jobが全テナントを対象に処理する:

```text
1. 全アクティブテナントを取得
2. 各テナントの設定を確認（alertEmailEnabled = true のみ）
3. テナント別にアラート対象商品を集計
4. テナント別の通知先にメール送信
```

---

## API

| エンドポイント | メソッド | 説明 | 状態 |
| -------------- | -------- | ---- | ---- |
| /api/cron/alerts | GET | アラート定期実行 | TODO |
| /api/admin/send-alerts | POST | 手動アラートメール送信 | TODO |
| /api/photos/upload | POST | 写真アップロード（Cloudflare R2） | 実装済み |

---

## TODO

- [ ] メール送信基盤の選定・実装（Resend等）
- [ ] メールテンプレート作成（TypeScript）
- [ ] Cron Job実装（テナント別処理）
- [ ] 手動送信API
- [x] 写真アップロードAPI（Cloudflare R2）
- [ ] カメラコンポーネント実装
- [ ] テナント設定のアラート項目連携
