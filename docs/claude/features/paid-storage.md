# 有料預かり管理

**状態:** UIシェル（タブのみ、データ連携TODO）

有料預かり商品の登録・管理を行う画面。2タブ構成。

**URL:** `/paid-storage`（担当者）、`/admin/paid-storage`（管理者）
**ファイル:**
- `src/app/(worker)/paid-storage/page.tsx`
- `src/app/admin/(dashboard)/paid-storage/page.tsx`

---

## 2タブ構成

| タブ | 機能 | 説明 |
| ---- | ---- | ---- |
| 有料預かり登録 | 検索ベースで有料預かり登録 | 全商品から検索して有料預かりに移行 |
| 有料預かり中 | `paid_storage`ステータス一覧 | 有料預かり中商品の表示・フィルタ検索 |

---

## 有料預かり登録タブ

**検索対象:** `completed`, `cancelled`, `paid_storage`以外の全商品

- received（受付済）
- pending_ship（業者への発送待ち）
- processing（加工中）
- returned（顧客へ返送待ち）
- rework（再加工）
- on_hold（顧客への返送保留）
- awaiting_customer（顧客確認待ち）

**操作フロー:**
1. 預かり番号または顧客名で検索
2. 検索結果から商品を選択（複数選択可）
3. 「有料預かりに登録」ボタンで一括登録
4. 確認モーダル → 登録実行

**用途:** お客様との合意後、任意の商品を有料預かりに登録可能。

---

## 有料預かり中タブ

- `paid_storage`ステータスの商品を一覧表示
- 預かり番号・顧客名・商品名でフィルタ検索
- 有料日数の多い順にソート
- カードクリックで商品詳細へ遷移

---

## 有料預かり対象フラグ（is_paid_storage）

商品に `is_paid_storage: true` が設定されると有料預かり商品として管理される。

### 設定されるタイミング

- 受付時に「長期保管（有料預かり）」チェックボックスをONにした場合
- 業者からの返却受入時に「有料預かり」チェックボックスをONにした場合
- 有料預かり管理画面から手動で有料預かりに登録した場合

### フラグの効果

- 有料預かり対象の商品: 業者からの返却受入時の返送予定日制限がない（任意の未来日を設定可能）
- 通常の商品: 返送予定日は業者からの返却日から設定に基づく日数以内に制限
- ダッシュボードの「有料預かり」カードでカウントされる

### フロー

```text
受付 → ... → returned → 手動で有料預かりに移行 → paid_storage → completed
```

※ 有料預かりへの移行は全て手動で行う（`/paid-storage` 画面または業者からの返却受入時）

---

## 有料預かり開始日（paid_storage_start_date）

有料預かり登録時に `paid_storage_start_date` が設定される。

- **設定タイミング**: 有料預かり管理画面で有料預かりに登録した時点の日付
- **用途**: 商品詳細画面で有料預かり開始日として表示、有料日数の計算基準日

---

## ステータス遷移

| 操作 | 遷移 | 画面 |
| ---- | ---- | ---- |
| 有料預かり移行 | returned → paid_storage | /paid-storage（手動） |
| 顧客への返送 | paid_storage → completed | /shipping |

---

## 商品カード表示

- 商品写真サムネイル（加工後写真優先、表面・裏面の2枚表示、48x48px）
- 顧客名、商品種別バッジ、ステータスバッジ（登録タブのみ）
- 預かり番号（短縮形式）
- 返送予定日（有料預かり中タブ）または有料日数バッジ
- 有料預かり中タブ: 黄土色左ボーダー（`border-l-oudo`）

---

## データベーステーブル

### items テーブル（関連カラム）

| カラム | 型 | 説明 |
| ------ | -- | ---- |
| is_paid_storage | BOOLEAN | 有料預かり対象フラグ |
| paid_storage_start_date | DATE | 有料預かり開始日 |

---

## テナント設定

| 設定キー | デフォルト | 説明 |
| -------- | ---------- | ---- |
| paidStorageGraceDays | 7 | 有料預かり猶予日数 |

---

## API

| エンドポイント | メソッド | 説明 | 状態 |
| -------------- | -------- | ---- | ---- |
| /api/items | GET | ステータス別商品一覧 | TODO |
| /api/items/[itemNumber] | PATCH | is_paid_storage更新・ステータス遷移 | TODO |

---

## TODO

- [ ] 有料預かり対象の商品一覧取得
- [ ] 有料預かり登録・解除機能
- [ ] ステータス遷移（returned → paid_storage → completed）
- [ ] 有料日数の計算・表示
- [ ] 有料預かり開始日の自動設定
- [ ] 操作ログ記録
